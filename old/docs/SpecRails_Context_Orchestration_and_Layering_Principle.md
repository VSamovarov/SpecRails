# üß≠ **SpecRails Context Orchestration & Layering Principle**

## üéØ –¶–µ–ª—å

> –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ SpecRails —Å–æ–±–∏—Ä–∞–µ—Ç, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–ª—è AI-–∞–≥–µ–Ω—Ç–æ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π, DSL –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ SpecRails ‚Äî —ç—Ç–æ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, —Ñ–æ—Ä–º–∏—Ä—É—é—â–∞—è ¬´–æ–∫—Ä—É–∂–µ–Ω–∏–µ¬ª –¥–ª—è AI.
–û–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ–±—ã –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ user story –¥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ–æ—Ä–º—ã ‚Äî –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ä–∞–º–∫–∞—Ö: –ø—Ä–æ–µ–∫—Ç, –¥–æ–º–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∏—Å—Ç–æ—Ä–∏—è –∏ –∑–Ω–∞–Ω–∏—è.

---

## üß© 1. –†–æ–ª—å Context Orchestration Layer

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                               |
| ------------------------ | ------------------------------------------------------------------------ |
| **Context Orchestrator** | –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–±–æ—Ä–∫–æ–π –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ AI                |
| **Context Layers**       | –õ–æ–≥–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏ –¥–∞–Ω–Ω—ã—Ö (project, domain, user, runtime, memory)        |
| **Context Resolver**     | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏ |
| **Context Normalizer**   | –ü—Ä–∏–≤–æ–¥–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π AI                   |
| **Layer Policy Manager** | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞                |

---

## üß± 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ü—Ä–∏–Ω—Ü–∏–ø                       | –û–ø–∏—Å–∞–Ω–∏–µ                                                                   |
| ----------------------------- | -------------------------------------------------------------------------- |
| **Layered Context**           | –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö, –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–ª–æ—ë–≤              |
| **Deterministic Composition** | –ö–∞–∂–¥—ã–π —Å–ª–æ–π –∏–º–µ–µ—Ç —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞                   |
| **Minimal Contamination**     | –î–∞–Ω–Ω—ã–µ –æ–¥–Ω–æ–≥–æ —Å–ª–æ—è –Ω–µ –¥–æ–ª–∂–Ω—ã –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –∏–∑–º–µ–Ω—è—Ç—å –¥—Ä—É–≥–æ–π                |
| **Context Traceability**      | –ö–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç AI —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω –±—ã–ª —Å–æ–±—Ä–∞–Ω |
| **Fallback Isolation**        | –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç –∏–∑ Constitution –∏–ª–∏ KB             |

---

## üß© 3. –°–ª–æ–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

| –£—Ä–æ–≤–µ–Ω—å       | –ò—Å—Ç–æ—á–Ω–∏–∫                   | –ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ                             |
| ------------- | -------------------------- | ---------------------------------------------- |
| **System**    | Prompt Constitution        | –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã, —Å—Ç–∏–ª—å, —ç—Ç–∏–∫–∞                   |
| **Domain**    | Knowledge Base             | –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è UI, –º–æ–¥–µ–ª–µ–π, ACL, FSM              |
| **Project**   | –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞          | –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π |
| **User**      | –ê–Ω–∞–ª–∏—Ç–∏–∫ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä    | –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —Å—Ç–∏–ª—å, –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è           |
| **Runtime**   | –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞, –æ—à–∏–±–∫–∏, –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã               |
| **Ephemeral** | –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ         | –¢–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç, —Ñ–æ—Ä–º–∞, –∫–æ–º–∞–Ω–¥–∞ `/generate`   |

---

## ‚öôÔ∏è 4. –ú–µ—Ö–∞–Ω–∏–∑–º —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```mermaid
graph TD
A[User Input / Command] --> B[Context Resolver]
B --> C[Load Project Layer]
C --> D[Merge Domain Layer]
D --> E[Attach Constitution]
E --> F[Inject Runtime State]
F --> G[Assemble Final Context]
G --> H[Send to Prompt Runtime]
```

---

## üß† 5. –ü—Ä–∏–º–µ—Ä —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```yaml
final_context:
  constitution: "prompt_constitution.v1"
  project:
    name: "Education Portal"
    entities: ["student", "teacher"]
  domain: "ui/forms"
  user:
    name: "Viktor"
    role: "analyst"
  runtime:
    document: "User and Board Data management-v15"
    history_ref: "#session_245"
  ephemeral:
    command: "/generate form for student registration"
```

---

## üîÅ 6. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Å–ª–æ—ë–≤

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°–ª–æ–π                      | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ                                   |
| --------- | ------------------------- | --------------------------------------------------------- |
| 1Ô∏è‚É£       | **Ephemeral**             | –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ (–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞)      |
| 2Ô∏è‚É£       | **Runtime**               | –ò–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ |
| 3Ô∏è‚É£       | **User**                  | –ú–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –¥–µ—Ñ–æ–ª—Ç—ã, –Ω–æ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã    |
| 4Ô∏è‚É£       | **Project**               | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–æ–º–µ–Ω–∞            |
| 5Ô∏è‚É£       | **Domain**                | –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –∑–Ω–∞–Ω–∏—è                     |
| 6Ô∏è‚É£       | **System (Constitution)** | –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã, –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã                  |

---

## üîç 7. –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:**

* Constitution —Ç—Ä–µ–±—É–µ—Ç –ª–∞–∫–æ–Ω–∏—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞.
* User –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å.
* Domain –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º.
* Project layer –¥–µ–ª–∞–µ—Ç –µ–≥–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º.

**–†–µ—à–µ–Ω–∏–µ:**

* Constitution –∏–º–µ–µ—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å –Ω–µ–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º–æ—Å—Ç–∏.
* Project layer –ø–æ–±–µ–∂–¥–∞–µ—Ç Domain, —Ç–∞–∫ –∫–∞–∫ –∏–º–µ–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å.
* User layer —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ *–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ*, –∞ –Ω–µ *–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ*.

---

## üß© 8. Layer Policy Manager

```yaml
layer_policy:
  immutable_layers: ["system", "constitution"]
  overridable_layers: ["project", "user", "runtime"]
  ephemeral_expiry: 1 session
  merge_strategy:
    project > domain
    runtime > project
    ephemeral > all
```

---

## üìä 9. –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                           |
| --------------------------- | ---------------------------------------------------- |
| **Context Depth**           | –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–æ—ë–≤ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ AI      |
| **Merge Conflict Rate**     | –ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–ª–ª–∏–∑–∏–π –º–µ–∂–¥—É —Å–ª–æ—è–º–∏                        |
| **Resolution Latency**      | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞                       |
| **Drift Sync Ratio**        | –î–æ–ª—è —Å–ª–æ—ë–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–Ω–∞–Ω–∏—è           |
| **Context Stability Index** | –ù–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –≤–≤–æ–¥–µ |

---

## üß≠ 10. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø

> **–ö–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî —ç—Ç–æ –Ω–µ –¥–∞–Ω–Ω—ã–µ, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º—ã—à–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.**
> Context Orchestration –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ñ—Ä–µ–π–º,
> –≥–¥–µ –∫–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è AI –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞, –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∞ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–∞.
